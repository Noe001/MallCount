# デプロイメントガイド

このドキュメントでは、AEONモール訪問記録アプリを無料でWeb上にデプロイする手順を説明します。

## 目次

1. [前提条件](#前提条件)
2. [Neon Database のセットアップ](#neon-database-のセットアップ)
3. [Render.com へのデプロイ](#rendercom-へのデプロイ)
4. [環境変数の設定](#環境変数の設定)
5. [デプロイの確認](#デプロイの確認)
6. [トラブルシューティング](#トラブルシューティング)
7. [無料プランの制限事項](#無料プランの制限事項)

## 前提条件

- GitHubアカウント
- コードがGitHubリポジトリにプッシュされていること
- `.gitignore`に`.env`と`node_modules`が含まれていること

## Neon Database のセットアップ

### 1. Neonアカウントの作成

1. [Neon](https://neon.tech/)にアクセス
2. 「Sign Up」をクリックしてアカウントを作成
3. GitHubアカウントでサインアップすることを推奨

### 2. 新しの作成

1. Neonダッシュボードで「New Project」をクリック
2. プロジェクト名を入力（例: `aeon-mall-tracker`）
3. リージョンを選択（日本に近いリージョンを推奨: `AWS Asia Pacific (Tokyo)`）
4. PostgreSQLバージョンは最新版を選択
5. 「Create Project」をクリック

### 3. データベース接続文字列の取得

1. プロジェクトダッシュボードで「Connection Details」を確認
2. 「Connection string」をコピー
3. 形式: `postgresql://[user]:[password]@[host]/[database]?sslmode=require`
4. この文字列を後で使用するため、安全な場所に保存

### 4. データベースの初期化

データベースのスキーマは、Render.comへのデプロイ時に自動的に作成されます（`npm run db:push`が実行されます）。

## Render.com へのデプロイ

### 1. Renderアカウントの作成

1. [Render.com](https://render.com/)にアクセス
2. 「Get Started」をクリック
3. GitHubアカウントでサインアップすることを推奨

### 2. GitHubリポジトリの連携

1. Renderダッシュボードで「New +」→「Web Service」をクリック
2. 「Connect a repository」でGitHubを選択
3. リポジトリへのアクセスを許可
4. デプロイするリポジトリを選択

### 3. Web Serviceの設定

以下の設定を入力します：

**Basic Settings:**
- **Name**: `aeon-mall-tracker`（任意の名前）
- **Region**: `Singapore`（日本に近いリージョン）
- **Branch**: `main`（またはデフォルトブランチ）
- **Runtime**: `Node`

**Build & Deploy:**
- **Build Command**: 
  ```bash
  npm install && npm run build && npm run db:push
  ```
- **Start Command**: 
  ```bash
  npm start
  ```

**Plan:**
- **Free**を選択

### 4. 環境変数の設定（次のセクションで詳細説明）

「Advanced」→「Add Environment Variable」をクリックして、必要な環境変数を追加します。

## 環境変数の設定

Renderの「Environment」タブで以下の環境変数を設定します：

### 必須の環境変数

#### 1. DATABASE_URL
- **値**: Neonから取得した接続文字列
- **例**: `postgresql://user:password@ep-xxx.us-east-2.aws.neon.tech/neondb?sslmode=require`

#### 2. SESSION_SECRET
- **値**: 強力なランダム文字列
- **生成方法**:
  ```bash
  node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
  ```
- Renderの「Generate Value」ボタンを使用することも可能

#### 3. NODE_ENV
- **値**: `production`

#### 4. PORT
- **値**: Renderが自動的に設定するため、設定不要
- ローカル開発では`5000`を使用

### 環境変数の追加手順

1. Renderダッシュボードで作成したWeb Serviceを選択
2. 「Environment」タブをクリック
3. 「Add Environment Variable」をクリック
4. キーと値を入力
5. 「Save Changes」をクリック

## デプロイの確認

### 1. デプロイの開始

環境変数を設定後、Renderが自動的にデプロイを開始します。

### 2. ビルドログの確認

1. 「Logs」タブでビルドの進行状況を確認
2. エラーがないことを確認
3. `npm run db:push`が正常に実行されることを確認

### 3. デプロイ完了の確認

1. ビルドが完了すると、「Live」ステータスになります
2. 提供されたURLにアクセス（例: `https://aeon-mall-tracker.onrender.com`）
3. 初回アクセス時は起動に30秒〜1分かかる場合があります

### 4. 動作確認

1. ユーザー登録ページにアクセス
2. 新しいアカウントを作成
3. ログイン
4. モール一覧が表示されることを確認
5. 訪問記録の追加・削除が正常に動作することを確認

### 5. モバイルブラウザでの確認

1. スマートフォンのブラウザでURLにアクセス
2. レスポンシブデザインが正しく表示されることを確認
3. タッチ操作が正常に動作することを確認

## トラブルシューティング

### デプロイが失敗する

**症状**: ビルドエラーが発生する

**解決方法**:
1. ログを確認してエラーメッセージを特定
2. `package.json`の`build`スクリプトが正しいことを確認
3. 依存関係が正しくインストールされているか確認

### データベース接続エラー

**症状**: `Error: connect ECONNREFUSED`または`database connection failed`

**解決方法**:
1. `DATABASE_URL`が正しく設定されているか確認
2. Neonデータベースがアクティブであることを確認
3. 接続文字列に`?sslmode=require`が含まれているか確認
4. Neonダッシュボードで接続文字列を再確認

### セッションが保持されない

**症状**: ログイン後すぐにログアウトされる

**解決方法**:
1. `SESSION_SECRET`が設定されているか確認
2. `NODE_ENV=production`が設定されているか確認
3. ブラウザのCookieが有効になっているか確認

### 初回アクセスが遅い

**症状**: アプリケーションへのアクセスに時間がかかる

**原因**: Renderの無料プランでは15分間非アクティブ時にスリープします

**解決方法**:
- これは正常な動作です
- 初回アクセス時は30秒〜1分待ってください
- アクティブになった後は通常速度で動作します

### モール一覧が表示されない

**症状**: ログイン後、モール一覧が空

**解決方法**:
1. データベースマイグレーションが正常に実行されたか確認
2. ログで`npm run db:push`のエラーを確認
3. 必要に応じて、シードデータを手動で投入:
   ```bash
   # ローカルで実行
   DATABASE_URL=<your-neon-url> npm run db:seed
   ```

### ビルドコマンドのタイムアウト

**症状**: ビルドが途中で停止する

**解決方法**:
1. Renderの無料プランではビルド時間に制限があります
2. 不要な依存関係を削除
3. `package-lock.json`をコミットして、インストール時間を短縮

## 無料プランの制限事項

### Neon Database（無料プラン）

**制限**:
- **ストレージ**: 0.5GB
- **アクティブ時間**: 月間100時間
- **コンピュート**: 1つのブランチ
- **自動スリープ**: 非アクティブ時に自動的にスリープ

**影響**:
- 1〜2名の使用には十分
- 月間100時間 = 1日約3.3時間のアクティブ時間
- 初回接続時に数秒の遅延が発生する可能性

**対策**:
- データベースのアクティブ時間を監視
- Neonダッシュボードで使用状況を確認
- 必要に応じて有料プランへのアップグレードを検討

### Render.com（無料プラン）

**制限**:
- **メモリ**: 512MB
- **スリープ**: 15分間非アクティブ時に自動スリープ
- **起動時間**: スリープからの復帰に30秒〜1分
- **稼働時間**: 月間750時間

**影響**:
- 初回アクセス時に待ち時間が発生
- 頻繁にアクセスしない場合は毎回起動が必要
- メモリ制限により、大量のデータ処理には不向き

**対策**:
- 初回アクセス時の待ち時間を考慮
- 定期的にアクセスしてスリープを防ぐ（オプション）
- UptimeRobotなどの監視サービスで定期的にpingを送る（オプション）

### 推奨される使用方法

1. **個人利用または小規模利用に最適**
   - 1〜2名の使用
   - 頻繁なアクセスがない場合

2. **データのバックアップ**
   - Neonの自動バックアップを活用
   - 重要なデータは定期的にエクスポート

3. **パフォーマンスの最適化**
   - 不要なクエリを削減
   - キャッシングを活用

4. **スケールアップの検討**
   - ユーザー数が増加した場合
   - より高いパフォーマンスが必要な場合
   - 有料プランへのアップグレードを検討

## 継続的なデプロイ

Renderは自動的にGitHubリポジトリと連携しています：

1. コードをGitHubにプッシュ
2. Renderが自動的にビルドとデプロイを開始
3. デプロイが完了すると、新しいバージョンが公開されます

**注意**: 環境変数の変更後は、手動でサービスを再起動する必要があります。

## サポートとリソース

- **Neon Documentation**: https://neon.tech/docs
- **Render Documentation**: https://render.com/docs
- **プロジェクトのIssue**: GitHubリポジトリのIssuesセクション

## デプロイ後のメンテナンス

### 定期的な確認事項

1. **使用状況の監視**
   - Neonダッシュボードでアクティブ時間を確認（月間100時間の制限）
   - Renderダッシュボードでメモリ使用量を確認

2. **データのバックアップ**
   - Neonの自動バックアップ機能を活用
   - 重要なデータは定期的にエクスポート

3. **アプリケーションの更新**
   - GitHubにコードをプッシュすると自動デプロイ
   - デプロイログを確認してエラーがないことを確認

### サービスの削除方法

テスト後にサービスを削除する場合：

**Render.comのサービス削除**:
1. Renderダッシュボードでサービスを選択
2. 「Settings」タブをクリック
3. 下部の「Delete Service」をクリック
4. サービス名を入力して確認

**Neon Databaseの削除**:
1. Neonダッシュボードでプロジェクトを選択
2. 「Settings」をクリック
3. 下部の「Delete Project」をクリック
4. プロジェクト名を入力して確認

## よくある質問（FAQ）

### Q: デプロイにかかる時間は？

A: 初回デプロイは5〜10分程度です。ビルドとデータベースマイグレーションが含まれます。

### Q: 複数のユーザーで使用できますか？

A: はい、可能です。無料プランは1〜2名の使用に最適ですが、それ以上のユーザーでも使用できます。ただし、パフォーマンスや制限に注意してください。

### Q: データは永続化されますか？

A: はい、Neon DatabaseのPostgreSQLに保存されるため、サーバーがスリープしてもデータは保持されます。

### Q: スマートフォンアプリとして使えますか？

A: ネイティブアプリではありませんが、ブラウザからアクセスできます。iOSの場合、Safariの「ホーム画面に追加」機能でアプリのように使用できます。

### Q: 無料プランから有料プランへの移行は簡単ですか？

A: はい、RenderとNeonの両方で、ダッシュボードから簡単にプランをアップグレードできます。データやアプリケーションはそのまま維持されます。

### Q: カスタムドメインは使えますか？

A: Renderの有料プラン（$7/月〜）でカスタムドメインを設定できます。無料プランでは`*.onrender.com`のサブドメインのみです。

## まとめ

このガイドに従うことで、AEONモール訪問記録アプリを無料でWeb上にデプロイし、スマートフォンブラウザからアクセスできるようになります。無料プランの制限を理解し、適切に使用することで、個人利用や小規模利用には十分な環境を構築できます。

**デプロイ完了後のチェックリスト**:
- ✅ Neon Databaseが作成され、接続可能
- ✅ Render.comでサービスがデプロイされ、「Live」ステータス
- ✅ 環境変数が正しく設定されている
- ✅ ユーザー登録とログインが動作する
- ✅ モール一覧が表示される
- ✅ 訪問記録の追加・削除が動作する
- ✅ スマートフォンブラウザからアクセス可能
- ✅ HTTPSで安全に接続できる

問題が発生した場合は、[トラブルシューティング](#トラブルシューティング)セクションを参照してください。

